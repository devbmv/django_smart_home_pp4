{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2 class="text-center my-4">Serial Data Received from ESP</h2>

    <!-- Afișăm starea UART -->
    <div class="row mb-3">
        <div class="col text-center">
            <span id="uart-status" class="badge badge-secondary p-2">UART Stopped</span>
        </div>
    </div>

    <!-- Mesaj temporar pentru a afișa statusul "UART started" sau "UART stopped" -->
    <div class="row">
        <div class="col text-center">
            <div id="uart-message" class="alert alert-info d-none"></div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col text-center">
            <button id="start-uart" class="btn btn-success mx-2">Start UART</button>
            <button id="stop-uart" class="btn btn-danger mx-2" disabled>Stop UART</button>
            <button id="clear-uart" class="btn btn-warning mx-2">Clear UART</button>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <table id="data-table" class="table table-bordered table-responsive-md table-striped">
                <thead>
                    <tr>
                        <th class="text-center">Data</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Datele vor fi încărcate din AJAX -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Funcție pentru a actualiza starea UART pe interfață
    function updateUARTStatus(status) {
        const uartStatusElement = document.getElementById('uart-status');
        const startButton = document.getElementById('start-uart');
        const stopButton = document.getElementById('stop-uart');
        
        if (status === 'running') {
            uartStatusElement.textContent = 'UART Running';
            uartStatusElement.className = 'badge badge-success p-2';  // Schimbă culoarea
            startButton.disabled = true;
            stopButton.disabled = false;
            showMessage('UART started', 'success');
        } else {
            uartStatusElement.textContent = 'UART Stopped';
            uartStatusElement.className = 'badge badge-secondary p-2';
            startButton.disabled = false;
            stopButton.disabled = true;
            showMessage('UART stopped', 'danger');
        }
    }

    // Funcție pentru a afișa mesajele temporare (ex: UART started, UART stopped)
    function showMessage(message, type) {
        const messageElement = document.getElementById('uart-message');
        messageElement.textContent = message;
        messageElement.className = `alert alert-${type}`;
        messageElement.classList.remove('d-none');
        
        // Mesajul va dispărea după 3 secunde
        setTimeout(function() {
            messageElement.classList.add('d-none');
        }, 3000);
    }

    // Funcție pentru a face cererea AJAX către server și a actualiza tabelul cu toate datele
    function updateData() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '{% url "uart_page" %}', true);  // Folosim același URL pentru AJAX
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  // Setăm header-ul pentru a indica că e cerere AJAX
        xhr.onload = function() {
            if (xhr.status === 200) {
                // Obținem masivul de date și îl folosim pentru a reconstrui tabelul
                var dataArray = JSON.parse(xhr.responseText).data;

                // Selectăm elementul <tbody> din tabel
                var tableBody = document.getElementById('table-body');
                tableBody.innerHTML = '';  // Golim conținutul tabelului

                // Iterăm prin masivul de date și creăm un rând nou pentru fiecare element
                dataArray.forEach(function(item) {
                    var newRow = '<tr><td>' + JSON.stringify(item) + '</td></tr>';
                    tableBody.innerHTML += newRow;
                });
            }
        };
        xhr.send();
    }

    // Funcția pentru a trimite comenzi către server pentru butoane
    function sendUARTCommand(command) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "uart_command" %}', true);  // Folosim un URL pentru a trimite comenzi UART
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');  // Adaugă token-ul CSRF
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                if (command === 'start') {
                    updateUARTStatus('running');  // Actualizăm statusul la "Pornit"
                } else if (command === 'stop') {
                    updateUARTStatus('stopped');  // Actualizăm statusul la "Oprit"
                } else if (command === 'clear') {
                    document.getElementById('table-body').innerHTML = '';  // Golește vizual tabelul
                }
                console.log('Comandă trimisă cu succes: ' + command);
            } else {
                console.error('Eroare la trimiterea comenzii: ' + command);
            }
        };
        xhr.send(JSON.stringify({ 'command': command }));
    }

    // Funcții pentru acțiunile butoanelor
    document.getElementById('start-uart').addEventListener('click', function() {
        sendUARTCommand('start');
    });

    document.getElementById('stop-uart').addEventListener('click', function() {
        sendUARTCommand('stop');
    });

    document.getElementById('clear-uart').addEventListener('click', function() {
        sendUARTCommand('clear');
    });

    // Apelează funcția updateData imediat după ce pagina este încărcată
    updateData();

    // Apelează funcția updateData la fiecare 3 secunde
    setInterval(updateData, 5000);
</script>
{% endblock %}
